name: Build Aurora Roleplay APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üîπ Checkout
        uses: actions/checkout@v4

      - name: ‚òï Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîß Permitir execu√ß√£o do Gradle
        run: chmod +x ./gradlew || true

      - name: üèóÔ∏è Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: üîê Decodificar keystore (se existir)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > aurora-release.keystore
            echo "‚úÖ Keystore decodificado com sucesso."
          else
            echo "‚ö†Ô∏è Nenhum keystore configurado, prosseguindo sem assinar."
          fi

      - name: üîè Assinar APK (se keystore existir)
        env:
          STORE_PASS: ${{ secrets.STORE_PASS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
          ALIAS: ${{ secrets.ALIAS }}
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          if [ -f aurora-release.keystore ] && [ -f "$APK_PATH" ]; then
            jarsigner -verbose -keystore aurora-release.keystore \
              -storepass "$STORE_PASS" -keypass "$KEY_PASS" \
              "$APK_PATH" "$ALIAS"
            echo "‚úÖ APK assinado com sucesso!"
          else
            echo "‚ö†Ô∏è Keystore ou APK n√£o encontrado, ignorando assinatura."
          fi

      - name: üì¶ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AuroraRoleplaySAMP-apk
          path: app/build/outputs/apk/release/app-release.apk
